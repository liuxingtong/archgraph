# 豆包 API 联网搜索配置指南

## 问题说明

豆包 API 报错：`MissingParameter: tools.function`

这是因为豆包 API 对工具调用的格式要求严格，当前代码中的 `extra_body` 格式不正确。

## 解决方案

### 方案一：在控制台配置联网搜索插件（推荐）

**这是最简单且推荐的方式**：

1. **登录火山方舟控制台**
   - 访问：https://console.volcengine.com
   - 进入「火山方舟」→「模型调用」

2. **找到你的推理接入点（Endpoint）**
   - 在「推理接入点」列表中找到你使用的接入点
   - 或创建新的接入点

3. **绑定联网搜索插件**
   - 点击接入点的「插件管理」或「工具配置」
   - 找到「联网搜索 Web Search」插件
   - 点击「启用」或「绑定」
   - 配置搜索预设（可选）

4. **完成配置**
   - 配置完成后，模型会自动使用联网搜索功能
   - **无需在代码中传递任何 tools 参数**
   - 代码会自动工作

**优点**：
- ✅ 配置简单，一次设置永久生效
- ✅ 不需要修改代码
- ✅ 避免 API 格式错误

**当前代码状态**：
- 代码已经移除了 `extra_body` 中的 `tools` 参数
- 如果控制台已配置插件，联网搜索会自动工作
- 如果控制台未配置，模型会基于训练数据回答（不会联网搜索）

---

### 方案二：通过代码传递 tools 参数（不推荐）

如果必须在代码中配置，需要使用正确的格式。但**不推荐**，因为：

1. 格式要求严格，容易出错
2. 需要频繁更新代码
3. 不如控制台配置稳定

**正确的格式应该是**（仅供参考，可能因API版本而异）：

```python
if use_web_search:
    kwargs["tools"] = [
        {
            "type": "web_search",
            "web_search": {
                "enable": True,
                "search_preset": "default"
            }
        }
    ]
    # 或者使用 extra_body（如果API要求）
    kwargs["extra_body"] = {
        "tools": [
            {
                "type": "web_search",
                "web_search": {
                    "enable": True,
                    "search_preset": "default"
                }
            }
        ]
    }
```

**但根据错误信息**，豆包 API 可能需要 `tools.function` 格式，这需要参考最新的官方文档。

---

## 推荐操作

### 立即操作：

1. ✅ **使用方案一（控制台配置）**
   - 登录火山方舟控制台
   - 为你的推理接入点绑定联网搜索插件
   - 测试搜索功能

2. ✅ **当前代码已修复**
   - 代码已移除错误的 `extra_body` 配置
   - 如果控制台已配置插件，功能会自动工作
   - 如果控制台未配置，模型会正常回答（但不联网搜索）

### 验证配置：

1. **测试搜索功能**
   ```python
   # 在应用中测试一个需要实时信息的查询
   # 例如："2024年最新的建筑案例"
   ```

2. **检查返回结果**
   - 如果返回了最新的、带 `source_url` 的结果 → 联网搜索正常工作
   - 如果返回的是训练数据中的信息 → 联网搜索未启用

---

## 常见问题

### Q: 为什么会出现 `tools.function` 错误？

A: 豆包 API 要求工具调用使用标准的 function calling 格式，而不是简单的 `web_search` 类型。控制台配置方式避免了这个问题。

### Q: 控制台配置后还需要修改代码吗？

A: **不需要**。控制台配置后，模型会自动使用联网搜索，代码无需任何修改。

### Q: 如何确认联网搜索是否启用？

A: 
- 测试一个需要实时信息的问题（如"最新的建筑新闻"）
- 查看返回结果是否包含最新的、带 `source_url` 的信息
- 或在控制台查看插件状态

### Q: 如果控制台没有联网搜索插件选项？

A: 
- 确认你的账号权限
- 确认接入点类型支持工具调用
- 联系火山方舟技术支持

---

## 方式二：代码配置（实验性）

### 能否找到正确的 URL？

**答案：理论上可以，但实际效果取决于多个因素**

#### 如果代码格式正确且 API 支持：

✅ **可以找到正确的 URL**
- 模型会进行联网搜索
- 返回的结果会包含 `source_url` 字段
- URL 来自真实的网络搜索结果

#### 但实际情况：

❌ **可能遇到的问题**：
1. **格式错误**：豆包 API 对 `tools` 格式要求严格，容易报错
2. **API 版本差异**：不同版本的 API 可能格式不同
3. **控制台配置冲突**：如果控制台已配置插件，代码配置可能冲突
4. **功能限制**：某些接入点可能不支持代码配置

### 当前代码实现

代码中已添加了方式二的尝试实现：

```python
if use_web_search:
    try:
        kwargs["extra_body"] = {
            "tools": [
                {
                    "type": "web_search",
                    "web_search": {
                        "enable": True,
                        "search_preset": "default"
                    }
                }
            ]
        }
    except Exception:
        pass
```

**注意**：
- 这个实现是实验性的
- 如果报错，会自动回退到不使用 tools
- 推荐使用方式一（控制台配置）

### 测试方式二

如果你想测试方式二：

1. **确保控制台未配置联网搜索插件**（避免冲突）
2. **运行代码，查看是否报错**
3. **如果报错**：
   - 错误信息会提示正确的格式
   - 根据错误信息调整格式
   - 或改用方式一

4. **如果成功**：
   - 测试一个需要实时信息的问题
   - 检查返回结果是否包含 `source_url`
   - 验证 URL 是否真实可访问

### 推荐策略

**最佳实践**：
1. ✅ **优先使用方式一**（控制台配置）
   - 稳定可靠
   - 一次配置永久生效
   - 避免代码错误

2. ⚠️ **方式二作为备选**
   - 仅在无法使用控制台时使用
   - 需要仔细测试格式
   - 可能因 API 更新而失效

## 总结

**推荐方案**：在火山方舟控制台配置联网搜索插件

**当前代码状态**：
- 已添加方式二的实验性实现
- 如果报错会自动回退
- 优先使用方式一（控制台配置）

**关于 URL**：
- ✅ 方式一（控制台配置）：**可以找到正确的 URL**，稳定可靠
- ⚠️ 方式二（代码配置）：**理论上可以**，但可能不稳定，需要测试

**下一步**：
1. 登录控制台，为你的推理接入点绑定联网搜索插件（推荐）
2. 或测试方式二，根据错误信息调整格式
